---
title: "publication_figures"
author: "Caroline Graham"
date: "3/30/2020"
output: html_document
---

## Loading packages and data

```{r}

#loading packages
ipak <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    sapply(pkg, require, character.only = TRUE)
}

packages <- c("tidyverse", "ggplot2", "here", "gridExtra", "tibble", "chron", "janitor", "lubridate", "data.table", "DataCombine", "plyr", "textclean", "remotes", "raster", "sp", "sf", "scales")
ipak(packages)


#importing data
sources <- read_csv(here::here("sources.csv"), col_types = "iiccccccccccccccccc")
diet_data <- read_csv(here::here("diet_data.csv"), col_types = "iiiiccccccccttnnnncccciiiiiicccnnnnnnicciciiiiicccccccccccnccccnnnnnnc")
prey_bio <- read_csv(here::here("prey_biological_data.csv"), col_types = "iiiiiccccccccttnnnncccciiiiiicccnnnnnnicciciiiiicccccccccccnnnnnnciiciiiiiccnnnnnc")
pred_bio <- read_csv(here::here("predator_biological_data.csv"), col_types = "iiiiccccccccttnnnncccciiiiiicccnnnnnnicciciiiiiccnnnnnc")
env_data <- read_csv(here::here("environmental_data.csv"), col_types = "iiiiccccccccttnnnncncicnnnnnc")
prey_gear <- read_csv(here::here("gear_type_prey.csv"), col_types = "icnnncnnncnnncnnncnnncnnncnnncc")
pred_gear <- read_csv(here::here("gear_type_predator.csv"), col_types = "icnnncnnncnnncnnncnnncnnncnnncc")
  
```


## Figure 1. The spatial distribution of diet samples across the North Pacific Ocean.

Note that in this chunk of code there is an error message created when writing the polygon csv files; however, this is not an error and does not affect the results. After running this chunk a second time, the code produces the plot for Figure 1. See comments on error here: https://stackoverflow.com/questions/61598340/why-does-rastertopoints-generate-an-error-on-first-call-but-not-second?fbclid=IwAR3X3-Etu-WNyXZVmq4p3EsG4vUJWlgS0pQW70zwe4AVIlZARwsINJyl3vA.

```{r}

#selecting unique predator_ids and coordinates from the diet_data
diet_data_uq_preds <- diet_data %>% 
  dplyr::select(predator_id, lat_min, lat_max, lon_min, lon_max) %>% 
  unique()

#subsetting polygon data
data1_diet <- diet_data_uq_preds %>% 
  dplyr::select(lat_min, lat_max, lon_min, lon_max)  %>%
  dplyr::filter(!is.na(lat_min) & !is.na(lat_max) & !is.na(lon_min) & !is.na(lon_max))

#subsetting horizontal transect data
data2_diet <- diet_data_uq_preds %>% 
  dplyr::select(lat_min, lat_max, lon_min, lon_max)  %>% 
  dplyr::filter(!is.na(lat_min) & (is.na(lat_max)) & !is.na(lon_min) & !is.na(lon_max))

#subsetting vertical transect data
data3_diet <- diet_data_uq_preds %>% 
  dplyr::select(lat_min, lat_max, lon_min, lon_max) %>% 
  dplyr::filter(!is.na(lat_min) & !is.na(lat_max) & !is.na(lon_min) & (is.na(lon_max)))

#subsetting point data
data4_diet <- diet_data_uq_preds %>% 
  dplyr::select(lat_min, lat_max, lon_min, lon_max) %>% 
  dplyr::filter(!is.na(lat_min) & (is.na(lat_max)) & !is.na(lon_min) & (is.na(lon_max)))

#fixing the lon values so they can be plotted on a scale from 0 to 360 degrees
data1_diet$lon_min[data1_diet$lon_min<0] = data1_diet$lon_min[data1_diet$lon_min<0] + 360
data1_diet$lon_max[data1_diet$lon_max<0] = data1_diet$lon_max[data1_diet$lon_max<0] + 360
data2_diet$lon_min[data2_diet$lon_min<0] = data2_diet$lon_min[data2_diet$lon_min<0] + 360
data2_diet$lon_max[data2_diet$lon_max<0] = data2_diet$lon_max[data2_diet$lon_max<0] + 360
data3_diet$lon_min[data3_diet$lon_min<0] = data3_diet$lon_min[data3_diet$lon_min<0] + 360
data4_diet$lon_min[data4_diet$lon_min<0] = data4_diet$lon_min[data4_diet$lon_min<0] + 360

#creating small polygons for points and lines so they can be plotted on a heatmap
data2_diet$lat_max = data2_diet$lat_min + 0.5
data3_diet$lon_max = data3_diet$lon_min + 0.5
data4_diet$lat_max = data4_diet$lat_min + 0.5
data4_diet$lon_max = data4_diet$lon_min + 0.5

#combining all of the different types of data (point, transect, area) into one dataframe
all_diet_data <- rbind(data1_diet, data2_diet, data3_diet, data4_diet)

#switching the lon values so that they are in the correct order
all_diet_data$lon_min1 <- ifelse(all_diet_data$lon_min > all_diet_data$lon_max, all_diet_data$lon_max, all_diet_data$lon_min)
all_diet_data$lon_max1 <- ifelse(all_diet_data$lon_min > all_diet_data$lon_max, all_diet_data$lon_min, all_diet_data$lon_max)

#if the difference between the min and max is less than 0.5 then I have to adjust the values
all_diet_data$lon_max2 <- ifelse(all_diet_data$lon_max1 - all_diet_data$lon_min1 < 0.5, 0.5 - (all_diet_data$lon_max1 - all_diet_data$lon_min1) + all_diet_data$lon_max1, all_diet_data$lon_max1)
all_diet_data$lat_max2 <- ifelse(all_diet_data$lat_max - all_diet_data$lat_min < 0.5, 0.5 - (all_diet_data$lat_max - all_diet_data$lat_min) + all_diet_data$lat_max, all_diet_data$lat_max)
        
#filtering out columns that I am interested in to make polygons
all_diet_data_edit <- all_diet_data %>% 
  dplyr::select(lat_min, lat_max2, lon_min1, lon_max2) %>%  
  dplyr::rename(lat_max = lat_max2,
                lon_min = lon_min1,
                lon_max = lon_max2)

#adding a sample_replicates column and assigning a value of 1 to all rows
all_diet_data_edit$sample_replicates = 1

#select unique sites and add the sample replicates together
all_diet_density_samples <- all_diet_data_edit %>% 
  group_by(lat_min, lat_max, lon_min, lon_max) %>%
    dplyr::summarise(sample_replicates = sum(sample_replicates))

#add an id column to help with making the polygon csv files
all_diet_density_samples$id <- seq(1,nrow(all_diet_density_samples),1)

#converting the world map into a raster
pacific <- map_data("world2")
pac_mod <- pacific
coordinates(pac_mod) <- ~long+lat
proj4string(pac_mod) <- CRS("+init=epsg:4326")
pac_mod2 <- spTransform(pac_mod, CRS("+init=epsg:4326"))
pac_rast <- raster(pac_mod2, resolution=0.5)
values(pac_rast) <- 1
raster::plot(pac_rast)

#creating a directory to store polygon csv files
dir.create("polygon_csvs")

#a funtion to write csv files for each of the polygons - ERROR HERE - need to run code a second time
ids = all_diet_density_samples$id
for (idnum in ids){
    poly1 = all_diet_density_samples[idnum,]
  pol = st_sfc(st_polygon(list(cbind(c(poly1$lon_min, poly1$lon_min, poly1$lon_max, poly1$lon_max, poly1$lon_min), c(poly1$lat_min, poly1$lat_max, poly1$lat_max, poly1$lat_min, poly1$lat_min)))))
  pol_sf = st_as_sf(pol)
  x <- rasterize(pol_sf, pac_rast)
  df1 <- raster::rasterToPoints(x, fun=NULL, spatial=FALSE)
  df2 <- as.data.frame(df1)
  density_poly <- all_diet_density_samples %>% filter(id == idnum) %>% pull(sample_replicates)
  df2$density <- density_poly
  write.csv(df2, here::here("code/polygon_csvs",file= paste0("pol_", idnum, ".csv")))
}

#reading back in polygon csv files
df_all <- as.data.frame(rasterToPoints(pac_rast)) %>% dplyr::select(-layer)
df_all$density <- 0
df_all$layer <- 0
for (idnum in ids){
    pol2 = read.csv(here::here("code/polygon_csvs",file= paste0("pol_", idnum, ".csv")), header = T)
    df_all <- bind_rows(df_all, pol2) 
}

#summing the densities of the spatial polygons
df_all_summarized <- df_all %>% group_by(x, y) %>%
      dplyr::summarize(layer=sum(layer,na.rm=TRUE), 
                density = sum(density, na.rm=TRUE),
                count = n())

#making heatmap
raster_map_density_samples <- ggplot() +
  geom_tile(data = df_all_summarized, aes(x=x, y=y, fill=density)) + 
  scale_fill_gradient(low = "white", high = "black") +
  geom_polygon(data = pacific, aes(x=long, y = lat, group = group), fill = 8, color = "black") +
  coord_cartesian(xlim = c(125, 241), ylim = c(25, 75), expand = F) + 
  scale_x_continuous(breaks = c(140, 160, 180, 200, 220, 240), labels = c("140°E", "160°E", "180°", "-160°W", "-140°W", "-120°W")) +
  scale_y_continuous(breaks = c(30, 40, 50, 60, 70), labels = c("30°N", "40°N", "50°N", "60°N", "70°N")) +
  labs(fill="Density of samples") +
  xlab("Longitude") + 
  ylab("Latitude") + 
  theme_bw()
raster_map_density_samples

#creates a new directory within the directory 'code' called 'final_figures' and stores the figure in this folder
dir.create("final_figures")
ggsave(here::here("final_figures","Fig1.png"), width =8 , height =4)

```


## Figure 2. The number of samples for each type of data reported across the temporal range 1950-2011. 

```{r}

#selecting unique data samples from each table, and selecting the year(s) the data was collected, then adding a column with the type of data (diet, environmental, prey bio, predator bio)
diet_data_select <- diet_data %>% dplyr::select(predator_id, year_min, year_max)
diet_data_uq <- unique(diet_data_select)
diet_data_col <- add_column(diet_data_uq, type_data = "diet", .before = "predator_id")
diet_data_select_final <- diet_data_col %>% dplyr::select(type_data, year_min, year_max)

pred_bio_select <- pred_bio %>% dplyr::select(predator_id, year_min, year_max)
pred_bio_uq <- unique(pred_bio_select)
pred_bio_col <- add_column(pred_bio_uq, type_data = "predator biological", .before = "predator_id")
pred_bio_select_final <- pred_bio_col %>% dplyr::select(type_data, year_min, year_max)

prey_bio_select <- prey_bio %>% dplyr::select(prey_id, year_min, year_max)
prey_bio_col <- add_column(prey_bio_select, type_data = "prey biological", .before = "prey_id")
prey_bio_select_final <- prey_bio_col %>% dplyr::select(type_data, year_min, year_max)

env_data_select <- env_data %>% dplyr::select(environmental_data_id, year_min, year_max)
env_data_col <- add_column(env_data_select, type_data = "environmental", .before = "environmental_data_id")
env_data_select_final <- env_data_col %>% dplyr::select(type_data, year_min, year_max)

#merging all 4 types of data
all_data_merged <- rbind(diet_data_select_final, pred_bio_select_final, prey_bio_select_final, env_data_select_final)

#parse data into 2 different dfs - one contains rows that do not have year_max values and the other contains rows that do have year_max values
all_data_merged_no_year_max <- all_data_merged %>% filter(is.na(year_max)) %>% 
  dplyr::select(type_data, year_min)
all_data_merged_yes_year_max <- all_data_merged %>% filter(!is.na(year_max))

#if there is a year_max then the median year between the min and max is selected, 0.5 values are rounded down
all_data_merged_yes_year_max$year_med <- (all_data_merged_yes_year_max$year_min + ((all_data_merged_yes_year_max$year_max - all_data_merged_yes_year_max$year_min)/2))
all_data_merged_yes_year_max$year_med_round <- trunc(all_data_merged_yes_year_max$year_med, 4)
all_data_merged_yes_year_max_edit <- all_data_merged_yes_year_max %>% 
  dplyr::select(type_data, year_med_round) %>% 
  dplyr::rename("year_min" = "year_med_round")

#merging dataframes with only year_min values
new_data_merged <- rbind(all_data_merged_yes_year_max_edit, all_data_merged_no_year_max)

#creating histogram displaying the types of data collected over time
temp_data_all <- ggplot(new_data_merged, aes(year_min)) +
  geom_histogram(aes(fill=type_data), 
                   binwidth = 1, 
                   col="black", 
                   size= .5) +
  scale_fill_manual(values=c("#FFFFFF", "#C0C0C0", "#606060", "#000000"), labels = c("diet", "environmental", "predator biological", "prey biological")) +
  scale_y_continuous(labels = comma, limits=c(0, 3300), breaks=c(0, 500, 1000, 1500, 2000, 2500, 3000)) +
  theme_classic() + 
  xlab("Year") + 
  ylab("Number of samples") +
  guides(fill=guide_legend(title="Type of data"))
temp_data_all

ggsave(here::here("final_figures","Fig2.png"), width =8 , height =4)

```


## Figure 3. The number of diet samples that contain each predator and each prey taxonomic classification. 

```{r}

### Predator frequency plot ###

#selecting unique predator samples with predator_lowest_taxonomic_level
diet_data_select_pred_spp <- diet_data %>% dplyr::select(predator_id, predator_lowest_taxonomic_level)
diet_data_select_pred_spp_uq <- unique(diet_data_select_pred_spp)

#changing from scientific names to common names
diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level[diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level == "Oncorhynchus gorbuscha"] = "Pink"
diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level[diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level == "Oncorhynchus nerka"] = "Sockeye"
diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level[diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level == "Oncorhynchus keta"] = "Chum"
diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level[diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level == "Oncorhynchus tshawytscha"] = "Chinook"
diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level[diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level == "Oncorhynchus kisutch"] = "Coho"
diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level[diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level == "Oncorhynchus mykiss"] = "Steelhead"

#set up the figure so that species are ordered from highest to lowest number of samples
diet_data_select_pred_spp_uq <- within(diet_data_select_pred_spp_uq, 
                   predator_lowest_taxonomic_level <- factor(predator_lowest_taxonomic_level, 
                                      levels=names(sort(table(predator_lowest_taxonomic_level), 
                                                        decreasing=TRUE))))

#make a frequency table for predator species
freqtable_pred_spp <- table(diet_data_select_pred_spp_uq$predator_lowest_taxonomic_level)
freqtable_pred_spp_df <- as.data.frame.table(freqtable_pred_spp)

#histogram of number of samples for each predator species
pred_spp_plot <- ggplot(freqtable_pred_spp_df, aes(x = reorder(Var1, -Freq), y = Freq)) +
  geom_bar(stat = "identity", width = 0.5, fill="#000000") + 
  scale_y_continuous(labels = comma) +
  theme_classic() + 
  xlab("Predator taxonomy") + 
  ylab("Number of samples") +
  ggtitle("a) Frequency of predator taxonomies")
pred_spp_plot

### Prey frequency plot ###

#select diet data with prey_lowest_taxonomic_level
diet_data_select_with_prey <- diet_data %>% dplyr::select(predator_id, prey_lowest_taxonomic_level)

#make a frequency table for prey items
freqtable_prey_taxo <- table(diet_data_select_with_prey$prey_lowest_taxonomic_level)
prey_taxo_df <- as.data.frame.table(freqtable_prey_taxo)
head(prey_taxo_df)

#remocve rows if the frequency is less than 20
prey_taxo_df_filter <- prey_taxo_df %>% filter(Freq > 20)

#histogram of number of samples containing each prey item
prey_spp_data <- ggplot(prey_taxo_df_filter, aes(x = reorder(Var1, -Freq), y = Freq))
prey_spp_plot <- prey_spp_data + 
  geom_bar(stat = "identity", width = 0.5, fill="#000000") + 
  scale_y_continuous(labels = comma) +
  theme_classic() + 
  xlab("Prey taxonomy") + 
  ylab("Number of samples") +
  ggtitle("b) Frequency of prey taxonomies") +
  theme(axis.text.x = element_text(angle=90, vjust=0.6, hjust=1))
prey_spp_plot

### Combining predator and prey figures into one figure ###
grid.arrange(pred_spp_plot, prey_spp_plot, nrow=2)
diet <- arrangeGrob(pred_spp_plot, prey_spp_plot, nrow=2)
ggsave(here::here("final_figures","Fig3.png"), diet, width =8, height =6)

```




